<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kindergarten Rapport Generator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a6da7;
            --primary-dark: #3a5a8f;
            --secondary-color: #5cb85c;
            --secondary-dark: #4cae4c;
            --background-color: #f5f7fa;
            --card-background: #ffffff;
            --text-color: #333333;
            --text-light: #666666;            --border-color: #e0e0e0;
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --background-color: #1a1a2e;
            --card-background: #16213e;
            --text-color: #ffffff;
            --text-light: #b0b0b0;
            --border-color: #3a3a5c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: var(--transition);
        }        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .navbar-brand {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            text-decoration: none;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }        .container {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: var(--transition);
        }        .container:hover {
            transform: translateY(-2px);
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 2rem;
            font-weight: 700;
            font-size: 2.5rem;
        }

        h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-weight: 600;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: var(--border-color);
            border-radius: 3px;
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            width: 0%;
            transition: width 0.3s ease;
        }

        .student-info {
            background: linear-gradient(135deg, #f8f9ff, #e8f0ff);
            border: 2px solid var(--border-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
        }        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .subject-row {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
        }

        label {
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        input[type="text"], input[type="email"], select, textarea {
            padding: 0.8rem;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            background-color: var(--card-background);
            color: var(--text-color);
            font-family: inherit;
            font-size: 1rem;
            transition: var(--transition);
        }        input[type="text"]:focus, input[type="email"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }        textarea {
            min-height: 100px;
            resize: vertical;
        }.comment-container {
            margin-top: 2rem;
            background: linear-gradient(135deg, #f0fff4, #e6ffed);
            border: 2px solid var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 2rem;
        }

        .comment-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .comment-option {
            background-color: var(--card-background);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            transition: var(--transition);
        }

        .comment-option:hover {
            border-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .comment-box {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            min-height: 200px;
            font-size: 1rem;
            line-height: 1.6;
            position: relative;
        }

        .word-count {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-light);
            background: rgba(255, 255, 255, 0.8);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        .buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
            color: white;
        }        .btn-secondary:hover {
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        .copy-button {
            background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }        .copy-button:hover {
            transform: translateY(-1px);
        }

        .toggle-icon {
            margin-right: 0.5rem;
            transition: transform 0.3s ease;
            font-size: 0.8rem;
        }

        .expanded .toggle-icon {
            transform: rotate(90deg);
        }

        .strength-weakness {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .behavioral-section {
            background: linear-gradient(135deg, #fff5f5, #ffe6e6);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .behavioral-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--card-background), #f8f9fa);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        .checkbox-custom {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            margin-right: 0.5rem;
            cursor: pointer;
            position: relative;
            transition: var(--transition);
        }

        .checkbox-custom:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .checkbox-custom:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--secondary-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #dc3545;
        }

        footer {
            margin-top: 3rem;
            text-align: center;
            color: var(--text-light);
            font-size: 0.9rem;
            padding: 2rem;
            border-top: 1px solid var(--border-color);
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .navbar-content {
                padding: 0 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .student-grid {
                grid-template-columns: 1fr;
            }
            
            .comment-options {
                grid-template-columns: 1fr;
            }
            
            .buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .navbar-controls {
                flex-direction: row;
                gap: 0.5rem;
            }
        }

        .export-options {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .quick-fill {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .quick-fill-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .quick-fill-btn {
            background: #ffc107;
            color: #000;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .quick-fill-btn:hover {
            background: #ffb300;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="#" class="navbar-brand">
                <i class="fas fa-graduation-cap"></i> Kindergarten Rapport Generator
            </a>
        </div>
    </nav>    <div class="main-container">
        <div class="container">
            <h1><i class="fas fa-child"></i> Kindergarten Rapport Generator</h1>
              <!-- Student Information Component -->
            <iframe 
                id="student-info-frame" 
                src="student-information.html" 
                style="width: 100%; height: 600px; border: none; border-radius: 12px; overflow: hidden;"
                onload="initializeStudentInfoFrame()">
            </iframe>
              <!-- Subject Selection Component -->
            <iframe 
                src="Subjects.html" 
                id="subjects-frame"
                style="width: 100%; height: 800px; border: none; border-radius: 12px;"
                onload="initializeSubjectsFrame()">
            </iframe><!-- Action Buttons -->
            <div class="buttons">
                <button class="btn btn-primary" id="generate-button">
                    <i class="fas fa-magic"></i> Generate Comments
                </button>
                <button class="btn btn-outline" onclick="clearAll()">
                    <i class="fas fa-trash"></i> Clear All
                </button>
                <button class="btn btn-secondary" onclick="fillSampleData()">
                    <i class="fas fa-database"></i> Sample Data
                </button>
                <button class="btn btn-outline" onclick="testFrames()" style="background: #ff6b35; color: white;">
                    <i class="fas fa-bug"></i> Test Frames
                </button>
            </div>
        </div>
        
        <div class="comment-container" id="comment-container" style="display: none;">
            <h2><i class="fas fa-comments"></i> Generated Comments</h2>
            <div class="comment-options">
                <div class="comment-option">
                    <div class="comment-title"><i class="fas fa-file-alt"></i> Comment Option 1:</div>
                    <div class="comment-box" id="comment1">
                        <div class="word-count" id="word-count-1">0 words</div>
                    </div>
                    <div class="buttons">
                        <button class="copy-button" onclick="copyComment('comment1')">
                            <i class="fas fa-copy"></i> Copy Comment 1
                        </button>
                        <button class="btn btn-outline" onclick="editComment('comment1')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                </div>
                <div class="comment-option">
                    <div class="comment-title"><i class="fas fa-file-alt"></i> Comment Option 2:</div>
                    <div class="comment-box" id="comment2">
                        <div class="word-count" id="word-count-2">0 words</div>
                    </div>
                    <div class="buttons">
                        <button class="copy-button" onclick="copyComment('comment2')">
                            <i class="fas fa-copy"></i> Copy Comment 2
                        </button>
                        <button class="btn btn-outline" onclick="editComment('comment2')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="export-options">
                <button class="btn btn-secondary" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf"></i> Export to PDF
                </button>
                <button class="btn btn-secondary" onclick="exportToWord()">
                    <i class="fas fa-file-word"></i> Export to Word
                </button>
                <button class="btn btn-secondary" onclick="printReport()">
                    <i class="fas fa-print"></i> Print Report
                </button>
                <button class="btn btn-outline" onclick="emailReport()">
                    <i class="fas fa-envelope"></i> Email Report
                </button>
            </div>
        </div>

        <footer>
            <p><i class="fas fa-heart"></i> Kindergarten Rapport Generator - Enhanced Version | Created by AI Assistant</p>
            <p>Designed to help teachers create meaningful, personalized student reports efficiently</p>
        </footer>
    </div>

    <!-- Notification container -->
    <div class="notification" id="notification"></div>

    <script>        // Enhanced Kindergarten Rapport Generator JavaScript
        
        // Global variables
        let currentTheme = 'light';
        let studentData = {};
        let studentInfoFrame;
        let subjectsFrame; // Add subjects frame reference
          // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadTheme();
            setupMessageListener();
            // Wait for iframes to load before setting up event listeners
            waitForIframesToLoad();
        });        // Wait for iframes to load properly
        function waitForIframesToLoad() {
            let studentFrameReady = false;
            let subjectsFrameReady = false;
            
            function checkIfReady() {
                if (studentFrameReady && subjectsFrameReady) {
                    console.log('Both iframes are ready, setting up event listeners');
                    setupEventListeners();
                    // Only update progress after both frames are ready
                    setTimeout(() => {
                        updateProgress();
                    }, 200);
                }
            }
            
            // Wait for student info iframe
            const studentFrame = document.getElementById('student-info-frame');
            if (studentFrame) {
                studentFrame.addEventListener('load', function() {
                    console.log('Student info iframe loaded');
                    setTimeout(() => {
                        const result = initializeStudentInfoFrame();
                        studentFrameReady = result;
                        checkIfReady();
                    }, 100);
                });
            }
            
            // Wait for subjects iframe
            const subjectsFrame = document.getElementById('subjects-frame');
            if (subjectsFrame) {
                subjectsFrame.addEventListener('load', function() {
                    console.log('Subjects iframe loaded');
                    setTimeout(() => {
                        const result = initializeSubjectsFrame();
                        subjectsFrameReady = result;
                        checkIfReady();
                    }, 100);
                });
            }
        }

        // Setup message listener for iframe communication
        function setupMessageListener() {
            window.addEventListener('message', function(event) {
                if (event.data.type === 'studentInfoUpdated') {
                    studentData = event.data.data;
                    updateSelectedSubjectsCount();
                    updateProgress();
                } else if (event.data.type === 'subjectsUpdated') {
                    updateProgress();
                }
            });
        }        // Initialize student info frame
        function initializeStudentInfoFrame() {
            try {
                const frame = document.getElementById('student-info-frame');
                if (frame && frame.contentWindow && frame.contentWindow.getStudentData) {
                    studentInfoFrame = frame.contentWindow;
                    console.log('Student info frame initialized successfully');
                    return true;
                } else {
                    console.error('Student info frame not ready - missing required functions');
                    return false;
                }
            } catch (error) {
                console.error('Error initializing student info frame:', error);
                return false;
            }
        }

        // Initialize subjects frame
        function initializeSubjectsFrame() {
            try {
                const frame = document.getElementById('subjects-frame');
                if (frame && frame.contentWindow && frame.contentWindow.getSubjectData) {
                    subjectsFrame = frame.contentWindow;
                    console.log('Subjects frame initialized successfully');
                    return true;
                } else {
                    console.error('Subjects frame not ready - missing required functions');
                    return false;
                }
            } catch (error) {
                console.error('Error initializing subjects frame:', error);
                return false;
            }
        }        // Get student data from iframe
        function getStudentDataFromFrame() {
            if (!studentInfoFrame || !studentInfoFrame.getStudentData) {
                console.warn('Student info frame not properly initialized');
                return {
                    name: '',
                    gender: 'male',
                    strengths: '',
                    weaknesses: '',
                    overallAttributes: 7
                };
            }
            
            try {
                const data = studentInfoFrame.getStudentData();
                console.log('Retrieved student data:', data);
                return data;
            } catch (error) {
                console.error('Error getting student data:', error);
                return {
                    name: '',
                    gender: 'male',
                    strengths: '',
                    weaknesses: '',
                    overallAttributes: 7
                };
            }
        }

        // Set student data in iframe
        function setStudentDataInFrame(data) {
            try {
                if (studentInfoFrame && studentInfoFrame.setStudentData) {
                    studentInfoFrame.setStudentData(data);
                } else {
                    console.warn('Student info frame not ready for setting data');
                }
            } catch (error) {
                console.error('Error setting student data:', error);
            }
        }

        // Clear student data in iframe
        function clearStudentDataInFrame() {
            try {
                if (studentInfoFrame && studentInfoFrame.clearStudentData) {
                    studentInfoFrame.clearStudentData();
                } else {
                    console.warn('Student info frame not ready for clearing data');
                }
            } catch (error) {
                console.error('Error clearing student data:', error);
            }
        }        // Get subject data from iframe
        function getSubjectDataFromFrame() {
            if (!subjectsFrame || !subjectsFrame.getSubjectData) {
                console.warn('Subjects frame not properly initialized');
                return {
                    english: { checked: false, activities: {} },
                    phonics: { checked: false, activities: {} },
                    mathematics: { checked: false, activities: {} },
                    iq: { checked: false, activities: {} },
                    'social-studies': { checked: false, activities: {} },
                    science: { checked: false, activities: {} },
                    conversation: { checked: false, activities: {} },
                    arts: { checked: false, activities: {} },
                    pe: { checked: false, activities: {} },
                    puppet: { checked: false, activities: {} }
                };
            }
            
            try {
                const data = subjectsFrame.getSubjectData();
                console.log('Retrieved subject data:', data);
                return data;
            } catch (error) {
                console.error('Error getting subject data:', error);
                return {
                    english: { checked: false, activities: {} },
                    phonics: { checked: false, activities: {} },
                    mathematics: { checked: false, activities: {} },
                    iq: { checked: false, activities: {} },
                    'social-studies': { checked: false, activities: {} },
                    science: { checked: false, activities: {} },
                    conversation: { checked: false, activities: {} },
                    arts: { checked: false, activities: {} },
                    pe: { checked: false, activities: {} },
                    puppet: { checked: false, activities: {} }
                };
            }
        }

        // Set subject data in iframe
        function setSubjectDataInFrame(data) {
            try {
                if (subjectsFrame && subjectsFrame.setSubjectData) {
                    subjectsFrame.setSubjectData(data);
                } else {
                    console.warn('Subjects frame not ready for setting data');
                }
            } catch (error) {
                console.error('Error setting subject data:', error);
            }
        }

        // Clear subject data in iframe
        function clearSubjectDataInFrame() {
            try {
                if (subjectsFrame && subjectsFrame.clearSubjectData) {
                    subjectsFrame.clearSubjectData();
                } else {
                    console.warn('Subjects frame not ready for clearing data');
                }
            } catch (error) {
                console.error('Error clearing subject data:', error);
            }
        }function initializeApp() {
            // The subject initialization is now handled by the subjects iframe
            // No need to initialize checkboxes here - handled by Subjects.html
        }
        
        // Load theme function
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            currentTheme = savedTheme;
            document.documentElement.setAttribute('data-theme', savedTheme);
        }
          // Update selected subjects count
        function updateSelectedSubjectsCount() {
            try {
                const subjectData = getSubjectDataFromFrame();
                let count = 0;
                Object.values(subjectData).forEach(subject => {
                    if (subject.checked) count++;
                });
                
                // Update the count in student info iframe if it exists
                if (studentInfoFrame && studentInfoFrame.document) {
                    const countElement = studentInfoFrame.document.getElementById('selected-subjects');
                    if (countElement) {
                        countElement.textContent = count;
                    }
                }
            } catch (error) {
                console.warn('Could not update selected subjects count:', error);
            }
        }        function setupEventListeners() {
            // Generate button
            const generateButton = document.getElementById('generate-button');
            if (generateButton) {
                generateButton.addEventListener('click', function() {
                    console.log('Generate button clicked');
                    
                    try {
                        // Validate that both iframes are ready
                        if (!studentInfoFrame || !studentInfoFrame.getStudentData) {
                            showNotification('Student information form not ready. Please wait a moment and try again.', 'error');
                            return;
                        }
                        
                        if (!subjectsFrame || !subjectsFrame.getSubjectData) {
                            showNotification('Subjects form not ready. Please wait a moment and try again.', 'error');
                            return;
                        }
                        
                        // Get current data
                        const currentStudentData = getStudentDataFromFrame();
                        const subjectData = getSubjectDataFromFrame();
                        
                        // Validate required data
                        if (!currentStudentData || !currentStudentData.name || !currentStudentData.name.trim()) {
                            showNotification('Please enter the student\'s name!', 'error');
                            return;
                        }
                        
                        // Check if any subjects are selected
                        const hasSelectedSubjects = Object.values(subjectData).some(subject => subject.checked === true);
                        if (!hasSelectedSubjects) {
                            showNotification('Please select at least one subject!', 'error');
                            return;
                        }
                        
                        console.log('All validation passed, generating comments...');
                        
                        showLoading();
                        
                        setTimeout(() => {
                            try {
                                generateComments();
                                hideLoading();
                                document.getElementById('comment-container').style.display = 'block';
                                document.getElementById('comment-container').scrollIntoView({ 
                                    behavior: 'smooth',
                                    block: 'start'
                                });
                                showNotification('Comments generated successfully!');
                            } catch (error) {
                                console.error('Error generating comments:', error);
                                hideLoading();
                                showNotification('Error generating comments: ' + error.message, 'error');
                            }
                        }, 500);
                        
                    } catch (error) {
                        console.error('Error in generate button handler:', error);
                        showNotification(error.message, 'error');
                    }
                });
            } else {
                console.error('Generate button not found');
            }
        }function updateStats() {
            // Update selected subjects count in iframe
            updateSelectedSubjectsCount();
        }        function updateProgress() {
            try {
                const currentStudentData = getStudentDataFromFrame();
                const subjectData = getSubjectDataFromFrame();
                
                let filledRequired = 0;
                let filledOptional = 0;
                let selectedSubjects = 0;
                
                // Check required fields from student data
                if (currentStudentData.name && currentStudentData.name.trim()) filledRequired++;
                
                // Check all student fields
                let filledStudentFields = 0;
                if (currentStudentData.name && currentStudentData.name.trim()) filledStudentFields++;
                if (currentStudentData.gender) filledStudentFields++;
                if (currentStudentData.strengths && currentStudentData.strengths.trim()) filledStudentFields++;
                if (currentStudentData.weaknesses && currentStudentData.weaknesses.trim()) filledStudentFields++;
                
                // Count selected subjects from iframe
                Object.values(subjectData).forEach(subject => {
                    if (subject.checked) selectedSubjects++;
                });
                
                const totalScore = (filledRequired * 3) + (filledStudentFields * 2) + (selectedSubjects * 1);
                const maxScore = (1 * 3) + (4 * 2) + (10 * 1); // 10 subjects total
                const progress = Math.min((totalScore / maxScore) * 100, 100);
                
                const progressBar = document.getElementById('progress-fill');
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
            } catch (error) {
                console.warn('Could not update progress:', error);
            }
        }

        // Quick fill functionality
        function addQuickText(fieldId, text) {
            document.getElementById(fieldId).value += text;
        }        // Enhanced copy functionality
        function copyComment(commentId) {
            const commentElement = document.getElementById(commentId);
            const commentText = commentElement.textContent.replace(/\d+ words$/, '').trim();
            
            navigator.clipboard.writeText(commentText).then(() => {
                showNotification('Comment copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = commentText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('Comment copied to clipboard!');
            });
        }

        // Edit comment functionality
        function editComment(commentId) {
            const commentElement = document.getElementById(commentId);
            const currentText = commentElement.textContent.replace(/\d+ words$/, '').trim();
            
            const textarea = document.createElement('textarea');
            textarea.value = currentText;
            textarea.style.width = '100%';
            textarea.style.minHeight = '200px';
            textarea.style.padding = '1rem';
            textarea.style.border = '2px solid var(--primary-color)';
            textarea.style.borderRadius = '8px';
            textarea.style.fontFamily = 'inherit';
            textarea.style.fontSize = '1rem';
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn btn-primary';
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            saveBtn.style.marginTop = '1rem';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-outline';
            cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
            cancelBtn.style.marginTop = '1rem';
            cancelBtn.style.marginLeft = '1rem';
            
            const buttonsDiv = document.createElement('div');
            buttonsDiv.appendChild(saveBtn);
            buttonsDiv.appendChild(cancelBtn);
            
            commentElement.innerHTML = '';
            commentElement.appendChild(textarea);
            commentElement.appendChild(buttonsDiv);
            
            saveBtn.onclick = () => {
                const newText = textarea.value;
                commentElement.innerHTML = newText + `<div class="word-count">${countWords(newText)} words</div>`;
                showNotification('Comment updated successfully!');
            };
            
            cancelBtn.onclick = () => {
                commentElement.innerHTML = currentText + `<div class="word-count">${countWords(currentText)} words</div>`;
            };
            
            textarea.focus();
        }

        // Word count utility
        function countWords(text) {
            return text.trim().split(/\s+/).filter(word => word.length > 0).length;
        }

        // Update word counts for comments
        function updateWordCounts() {
            // This function can be expanded to update word counts for all comment boxes
        }        // Sample data for testing
        function fillSampleData() {
            console.log('Filling sample data...');
            
            const sampleData = {
                name: 'Emma Johnson',
                gender: 'female',
                strengths: 'Creative and imaginative, Helpful to classmates, Good listener',
                weaknesses: 'Needs encouragement to participate in group activities',
                overallAttributes: 8,
                socialConfidence: 7
            };
            
            setStudentDataInFrame(sampleData);
              // Set sample subject data
            const sampleSubjectData = {
                english: { checked: true, activities: { activity1: true, activity2: true, activity3: true, vocabulary: true } },
                phonics: { checked: true, activities: { activity1: true, activity2: true, vocabulary: true } },
                mathematics: { checked: true, activities: { activity1: true, activity2: true, activity3: true, activity4: true, vocabulary: true } },
                arts: { checked: true, activities: { activity1: true, activity2: true, activity3: true, vocabulary: true } },
                science: { checked: false, activities: {} },
                conversation: { checked: true, activities: { activity1: true, activity2: true, activity3: true, vocabulary: true } },
                'social-studies': { checked: false, activities: {} },
                iq: { checked: false, activities: {} },
                pe: { checked: false, activities: {} },
                puppet: { checked: false, activities: {} }
            };
            
            setSubjectDataInFrame(sampleSubjectData);
            
            updateProgress();
            showNotification('Sample data loaded!');
        }// Clear all data
        function clearAll() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                // Clear student data in iframe
                clearStudentDataInFrame();
                
                // Clear subject data in iframe
                clearSubjectDataInFrame();
                
                document.getElementById('comment-container').style.display = 'none';

                updateProgress();
                showNotification('All data cleared!');
            }
        }

        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Loading states
        function showLoading() {
            const button = document.getElementById('generate-button');
            button.innerHTML = '<div class="loading-spinner"></div> Generating...';
            button.disabled = true;
        }

        function hideLoading() {
            const button = document.getElementById('generate-button');
            button.innerHTML = '<i class="fas fa-magic"></i> Generate Comments';
            button.disabled = false;
        }        // Export functionality
        function exportToPDF() {
            showNotification('PDF export feature coming soon!');
        }

        function exportToWord() {
            showNotification('Word export feature coming soon!');
        }
        
        // Copy to clipboard functionality for main comment
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                const text = element.textContent.replace(/\d+ words$/, '').trim();
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('Comment copied to clipboard!');
                }).catch(() => {
                    showNotification('Comment copied to clipboard!');
                });
            }
        }
        
        // Download as text functionality
        function downloadAsText() {
            const studentData = getStudentDataFromFrame();
            const mainComment = document.getElementById('main-comment');
            if (mainComment && studentData.name) {
                const text = mainComment.textContent.replace(/\d+ words$/, '').trim();
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${studentData.name}_report.txt`;
                a.click();
                URL.revokeObjectURL(url);
                showNotification('Report downloaded!');
            }
        }
        
        // Print comment functionality
        function printComment() {
            const studentData = getStudentDataFromFrame();
            const mainComment = document.getElementById('main-comment');
            if (mainComment) {
                const text = mainComment.textContent.replace(/\d+ words$/, '').trim();
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>Student Report - ${studentData.name || 'Student'}</title>
                        <style>
                            body { font-family: 'Times New Roman', serif; margin: 2cm; line-height: 1.6; }
                            h1 { color: #4a6da7; }
                        </style>
                    </head>
                    <body>
                        <h1>Kindergarten Report - ${studentData.name || 'Student'}</h1>
                        <p>${text}</p>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }
        }

        function printReport() {
            const printContent = document.getElementById('comment-container').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Student Report - ${document.getElementById('student-name').value}</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; margin: 2cm; }
                        .comment-box { border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; }
                        .comment-title { font-weight: bold; margin-bottom: 0.5rem; }
                        .word-count { display: none; }
                    </style>
                </head>
                <body>
                    <h1>Kindergarten Report - ${document.getElementById('student-name').value}</h1>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function emailReport() {
            const studentName = document.getElementById('student-name').value;
            const subject = `Kindergarten Report for ${studentName}`;
            const body = `Please find the kindergarten report for ${studentName} attached.`;
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }        // Enhanced comment generation system
        function generateComments() {
            try {
                // Get student information from iframe
                const currentStudentData = getStudentDataFromFrame();
                console.log('Generating comments with student data:', currentStudentData);
                
                const studentName = currentStudentData.name;
                const gender = currentStudentData.gender || 'other';
                const strengths = currentStudentData.strengths || '';
                const weaknesses = currentStudentData.weaknesses || '';
                const overallAttributes = currentStudentData.overallAttributes || 7;
                
                // Get selected subjects and their activity data from iframe
                const subjectData = getSubjectDataFromFrame();
                console.log('Subject data:', subjectData);
                
                const subjects = [
                    { name: 'English', id: 'english', ...subjectData.english },
                    { name: 'Phonics', id: 'phonics', ...subjectData.phonics },
                    { name: 'Mathematics', id: 'mathematics', ...subjectData.mathematics },
                    { name: 'I.Q', id: 'iq', ...subjectData.iq },
                    { name: 'Social Studies', id: 'social-studies', ...subjectData['social-studies'] },
                    { name: 'Science', id: 'science', ...subjectData.science },
                    { name: 'Conversation', id: 'conversation', ...subjectData.conversation },
                    { name: 'Arts', id: 'arts', ...subjectData.arts },
                    { name: 'Physical Education', id: 'pe', ...subjectData.pe },
                    { name: 'Puppet Show', id: 'puppet', ...subjectData.puppet }
                ];
                
                // Filter selected subjects
                const selectedSubjects = subjects.filter(subject => subject.checked === true);
                console.log('Selected subjects:', selectedSubjects);
                
                if (selectedSubjects.length === 0) {
                    throw new Error('No subjects selected. Please select at least one subject.');
                }
                
                // Generate enhanced AI comments
                const comment1 = generateEnhancedComment1(studentName, gender, strengths, weaknesses, overallAttributes, selectedSubjects);
                const comment2 = generateEnhancedComment2(studentName, gender, strengths, weaknesses, overallAttributes, selectedSubjects);
                
                console.log('Generated comment 1:', comment1);
                console.log('Generated comment 2:', comment2);
                
                // Set comments and update word counts
                const comment1Element = document.getElementById('comment1');
                const comment2Element = document.getElementById('comment2');
                
                if (!comment1Element || !comment2Element) {
                    throw new Error('Comment display elements not found. Please refresh the page.');
                }
                
                comment1Element.innerHTML = comment1 + `<div class="word-count">${countWords(comment1)} words</div>`;
                comment2Element.innerHTML = comment2 + `<div class="word-count">${countWords(comment2)} words</div>`;
                
                updateWordCounts();
            } catch (error) {
                console.error('Error in generateComments:', error);
                throw error; // Re-throw to be caught by caller
            }
        }

        function generateEnhancedComment1(studentName, gender, strengths, weaknesses, overallAttributes, selectedSubjects) {
            const pronouns = {
                male: { subject: 'he', object: 'him', possessive: 'his', reflexive: 'himself' },
                female: { subject: 'she', object: 'her', possessive: 'her', reflexive: 'herself' },
                other: { subject: 'they', object: 'them', possessive: 'their', reflexive: 'themselves' }
            };
            const pronoun = pronouns[gender] || pronouns.other;
              // Behavioral trait descriptors - using default values since behavioral section was removed
            const cooperationLevel = 3; // Default moderate level
            const attentionLevel = 3;   // Default moderate level  
            const independenceLevel = 3; // Default moderate level
            const creativityLevel = 3;   // Default moderate level
            
            const behavioralTraits = {
                cooperation: {
                    low: 'is developing collaborative skills',
                    medium: 'works well with others',
                    high: 'demonstrates excellent teamwork and cooperation'
                },
                attention: {
                    low: 'is building focus and concentration skills',
                    medium: 'maintains good attention during activities',
                    high: 'shows exceptional focus and sustained attention'
                },
                independence: {
                    low: 'benefits from guidance and support',
                    medium: 'demonstrates growing independence',
                    high: 'works independently with confidence'
                },
                creativity: {
                    low: 'is exploring creative expression',
                    medium: 'shows creative thinking in activities',
                    high: 'demonstrates exceptional creativity and imagination'
                }
            };
            
            function getTraitLevel(value) {
                if (value <= 2) return 'low';
                if (value <= 3) return 'medium';
                return 'high';
            }
              // Start building the comment
            let comment = `${studentName} is a wonderful young student who demonstrates a positive attitude toward learning. ${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} `;
              // Add behavioral observations using default values
            const behaviorTraits = [
                behavioralTraits.cooperation[getTraitLevel(cooperationLevel)],
                behavioralTraits.attention[getTraitLevel(attentionLevel)],
                behavioralTraits.independence[getTraitLevel(independenceLevel)]
            ];
            comment += `${behaviorTraits[Math.floor(Math.random() * behaviorTraits.length)]} and `;
            comment += `${behavioralTraits.creativity[getTraitLevel(creativityLevel)]}. `;
            
            // Add strengths if provided
            if (strengths.trim()) {
                const strengthsList = strengths.split(',').map(s => s.trim()).filter(s => s);
                if (strengthsList.length > 0) {
                    const selectedStrengths = strengthsList.slice(0, 2);
                    comment += `${pronoun.possessive.charAt(0).toUpperCase() + pronoun.possessive.slice(1)} particular strengths include ${selectedStrengths.join(' and ')}, which enhance ${pronoun.possessive} learning experience. `;
                }
            }
              // Add academic subjects for selected subjects
            if (selectedSubjects.length > 0) {
                const selectedSubjectNames = selectedSubjects.slice(0, 3).map(s => s.name || s.id);
                
                if (selectedSubjectNames.length === 1) {
                    comment += `${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} shows good engagement in ${selectedSubjectNames[0]} activities. `;
                } else if (selectedSubjectNames.length === 2) {
                    comment += `${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} demonstrates positive participation in ${selectedSubjectNames[0]} and ${selectedSubjectNames[1]}. `;
                } else {
                    comment += `${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} actively participates in various subjects including ${selectedSubjectNames[0]}, ${selectedSubjectNames[1]}, and ${selectedSubjectNames[2]}. `;                }
                  // Add specific activity comments for all subjects if selected
                selectedSubjects.forEach(subject => {
                    if (subject.activities) {
                        const activities = subject.activities;
                        const completedActivities = [];
                        
                        // English activities
                        if (subject.id === 'english') {
                            if (activities.activity1) completedActivities.push('matching letters with pictures');
                            if (activities.activity2) completedActivities.push('tracing and coloring letters');
                            if (activities.activity3) completedActivities.push('matching same letters');
                            if (activities.vocabulary) completedActivities.push('vocabulary development (A-Ant, B-Bee, C-Cat)');
                        }
                        
                        // Phonics activities
                        else if (subject.id === 'phonics') {
                            if (activities.activity1) completedActivities.push('letter A-E recognition');
                            if (activities.activity2) completedActivities.push('revision of A/B/C');
                            if (activities.vocabulary) completedActivities.push('vocabulary mastery with Annie Ant-Axe, Benny Bear-Ball, Candy Cat-Cut, Danny Dog-Dig, Eddie Elephant-Egg');
                        }
                        
                        // Mathematics activities
                        else if (subject.id === 'mathematics') {
                            if (activities.activity1) completedActivities.push('counting from 1-10');
                            if (activities.activity2) completedActivities.push('tracing numbers 1-3');
                            if (activities.activity3) completedActivities.push('placing correct amount of pictures');
                            if (activities.activity4) completedActivities.push('finger counting 1-10');
                            if (activities.vocabulary) completedActivities.push('number vocabulary one through ten');
                        }
                        
                        // I.Q activities
                        else if (subject.id === 'iq') {
                            if (activities.activity1) completedActivities.push('animal and food matching');
                            if (activities.activity2) completedActivities.push('shapes and colors identification');
                            if (activities.activity3) completedActivities.push('room objects recognition');
                            if (activities.vocabulary) completedActivities.push('vocabulary mastery including animals, shapes, colors, and household items');
                        }
                        
                        // Social Studies activities
                        else if (subject.id === 'social-studies') {
                            if (activities.activity1) completedActivities.push('farm animal characteristics and abilities');
                            if (activities.activity2) completedActivities.push('animal sounds, food, and offspring');
                            if (activities.activity3) completedActivities.push('body parts and face identification');
                            if (activities.vocabulary) completedActivities.push('vocabulary including farm animals and body parts');
                        }
                        
                        // Science activities
                        else if (subject.id === 'science') {
                            if (activities.activity1) completedActivities.push('floating and sinking experiments');
                            if (activities.activity2) completedActivities.push('dancing beans in soda experiment');
                            if (activities.activity3) completedActivities.push('buoyancy exploration with rocks');
                            if (activities.activity4) completedActivities.push('balloon blow-up experiments');
                            if (activities.activity5) completedActivities.push('magnifying glass exploration');
                            if (activities.activity6) completedActivities.push('dancing colors in milk experiment');
                            if (activities.vocabulary) completedActivities.push('science vocabulary including sink, float, bubbles, and magnifying glass');
                        }
                        
                        // Conversation activities
                        else if (subject.id === 'conversation') {
                            if (activities.activity1) completedActivities.push('age identification questions');
                            if (activities.activity2 || activities.activity3 || activities.activity4 || activities.activity5 || activities.activity6) {
                                completedActivities.push('daily routine conversations');
                            }
                            if (activities.activity7 || activities.activity8 || activities.activity9) {
                                completedActivities.push('food and nutrition discussions');
                            }
                            if (activities.vocabulary) completedActivities.push('conversation vocabulary including daily activities and food items');
                        }
                        
                        // Arts activities
                        else if (subject.id === 'arts') {
                            if (activities.activity1) completedActivities.push('paper caterpillar making');
                            if (activities.activity2) completedActivities.push('origami projects (fox, frog, ice cream)');
                            if (activities.activity3) completedActivities.push('cotton ball sheep creation');
                            if (activities.activity4) completedActivities.push('wobbly crab crafting');
                            if (activities.vocabulary) completedActivities.push('arts and crafts vocabulary');
                        }
                        
                        // Physical Education activities
                        else if (subject.id === 'pe') {
                            if (activities.activity1 || activities.activity2 || activities.activity3) {
                                completedActivities.push('ball handling skills');
                            }
                            if (activities.activity4) completedActivities.push('racing games');
                            if (activities.activity5) completedActivities.push('under the arches activities');
                            if (activities.activity6) completedActivities.push('football skills');
                            if (activities.vocabulary) completedActivities.push('physical education vocabulary');
                        }
                        
                        // Puppet Show activities
                        else if (subject.id === 'puppet') {
                            if (activities.activity1) completedActivities.push('Three Little Pigs performance');
                            if (activities.activity2) completedActivities.push('Red Riding Hood storytelling');
                            if (activities.activity3) completedActivities.push('The Panicked Rabbit story');
                            if (activities.activity4) completedActivities.push('No Don\'t Eat Vegetables puppet show');
                            if (activities.activity5) completedActivities.push('Lion and the Mouse performance');
                            if (activities.vocabulary) completedActivities.push('storytelling vocabulary');
                        }
                        
                        // Add activity comments to the report
                        if (completedActivities.length > 0) {
                            if (completedActivities.length === 1) {
                                comment += `In ${subject.name}, ${pronoun.subject} has successfully completed ${completedActivities[0]}. `;
                            } else if (completedActivities.length === 2) {
                                comment += `In ${subject.name}, ${pronoun.subject} has mastered ${completedActivities[0]} and ${completedActivities[1]}. `;
                            } else {
                                const randomSelection = completedActivities.slice(0, Math.min(3, completedActivities.length));
                                if (randomSelection.length === 3) {
                                    comment += `In ${subject.name}, ${pronoun.subject} has demonstrated proficiency in ${randomSelection[0]}, ${randomSelection[1]}, and ${randomSelection[2]}. `;
                                } else {
                                    comment += `In ${subject.name}, ${pronoun.subject} has shown excellent progress with ${randomSelection.join(' and ')}. `;
                                }
                            }
                        }
                    }
                });
            }
            
            // Add areas for improvement if provided
            if (weaknesses.trim()) {
                comment += `Areas for continued growth include ${weaknesses.toLowerCase()}. With ongoing support and practice, ${pronoun.subject} will continue to develop these important skills. `;
            }
            
            // Add encouraging closing based on overall engagement
            const closings = {
                high: [
                    `${studentName} consistently demonstrates excellent effort and a positive attitude toward learning. ${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} is a joy to have in our classroom community.`,
                    `I am impressed by ${studentName}'s dedication to learning and ${pronoun.possessive} kind interactions with classmates. ${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} is making excellent progress.`,
                    `${studentName} brings enthusiasm and curiosity to every learning opportunity. ${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} is well-prepared for continued academic success.`
                ],
                medium: [
                    `${studentName} is making steady progress and shows a genuine interest in learning. I look forward to ${pronoun.possessive} continued growth.`,
                   
                    `With consistent effort, ${studentName} continues to develop important foundational skills. ${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} is a valued member of our class.`,
                    `${studentName} demonstrates growing confidence in ${pronoun.possessive} abilities and is developing strong learning habits.`
                ],
                low: [
                    `${studentName} is building important foundational skills with determination. With continued support, ${pronoun.subject} will achieve success.`,
                    `I appreciate ${studentName}'s efforts and positive attitude. ${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} is making meaningful progress in ${pronoun.possessive} learning journey.`,
                    `${studentName} shows great potential and benefits from encouragement. I am confident in ${pronoun.possessive} ability to continue growing.`
                ]
            };
              let engagementLevel = 'medium';
            if (overallAttributes >= 8) engagementLevel = 'high';
            else if (overallAttributes <= 4) engagementLevel = 'low';
            
            const closingOptions = closings[engagementLevel];
            comment += closingOptions[Math.floor(Math.random() * closingOptions.length)];
            
            return comment;
        }

        function generateEnhancedComment2(studentName, gender, strengths, weaknesses, overallAttributes, selectedSubjects) {
            const pronouns = {
                male: { subject: 'he', object: 'him', possessive: 'his', reflexive: 'himself' },
                female: { subject: 'she', object: 'her', possessive: 'her', reflexive: 'herself' },
                other: { subject: 'they', object: 'them', possessive: 'their', reflexive: 'themselves' }
            };
            const pronoun = pronouns[gender] || pronouns.other;              // Alternative comment structure focusing on different aspects
            let comment = `It has been a pleasure working with ${studentName} this term. `;
            
            // Default values for behavioral traits since behavioral section was removed
            const attention = 3;      // Default moderate level
            const independence = 3;   // Default moderate level  
            const cooperation = 3;    // Default moderate level
            const creativity = 3;     // Default moderate level
            
            // Start with overall classroom presence
            comment += `${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} contributes positively to our classroom environment and demonstrates good social interactions with peers. `;
            
            // Focus on learning approach and work habits
            const workHabits = [];
            if (attention >= 4) workHabits.push('maintains excellent focus during lessons');
            else if (attention >= 2) workHabits.push('shows good concentration skills');
            else workHabits.push('is developing attention and focus abilities');
            
            if (independence >= 4) workHabits.push('demonstrates strong independence in learning tasks');
            else if (independence >= 2) workHabits.push('is building independence in daily activities');
            else workHabits.push('benefits from guided support in learning activities');
            
            if (cooperation >= 4) workHabits.push('collaborates effectively with classmates');
            else if (cooperation >= 2) workHabits.push('is learning to work well with others');
            else workHabits.push('is developing collaborative skills');
            
            comment += `${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} ${workHabits.slice(0, 2).join(' and ')}. `;
            
            // Highlight creativity and problem-solving
            if (creativity >= 4) {
                comment += `${pronoun.possessive.charAt(0).toUpperCase() + pronoun.possessive.slice(1)} creative thinking and imaginative approach to activities consistently impresses both teachers and classmates. `;
            } else if (creativity >= 2) {
                comment += `${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} demonstrates creative thinking in various learning activities. `;
            } else {
                comment += `${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} is exploring creative expression and developing ${pronoun.possessive} unique perspective. `;
            }
              // Academic achievements - focus on selected subjects
            if (selectedSubjects.length > 0) {
                const topSubjects = selectedSubjects.slice(0, 3);
                
                if (topSubjects.length > 0) {
                    comment += `Academically, ${studentName} shows positive engagement in `;
                    
                    if (topSubjects.length === 1) {
                        comment += `${topSubjects[0].name || topSubjects[0].id}, where ${pronoun.subject} demonstrates good understanding and participation. `;
                    } else if (topSubjects.length === 2) {
                        comment += `${topSubjects[0].name || topSubjects[0].id} and ${topSubjects[1].name || topSubjects[1].id}, showing consistent participation in these areas. `;
                    } else {
                        comment += `${topSubjects[0].name || topSubjects[0].id}, ${topSubjects[1].name || topSubjects[1].id}, and ${topSubjects[2].name || topSubjects[2].id}, demonstrating well-rounded academic development. `;
                    }
                }
                  // Add progress notes for additional subjects
                if (selectedSubjects.length > 3) {
                    const randomSubject = selectedSubjects[Math.floor(Math.random() * selectedSubjects.length)];
                    comment += `${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} also shows interest in ${randomSubject.name || randomSubject.id} and continues to build understanding in this area. `;
                }
                  // Add specific activity progress for all subjects if selected
                selectedSubjects.forEach(subject => {
                    if (subject.activities) {
                        const activities = subject.activities;
                        const completedActivities = [];
                        const incompleteActivities = [];
                        
                        // Check activities for each subject
                        if (subject.id === 'english') {
                            if (activities.activity1) completedActivities.push('letter-picture matching');
                            else incompleteActivities.push('letter-picture matching');
                            
                            if (activities.activity2) completedActivities.push('letter tracing');
                            else incompleteActivities.push('letter tracing');
                            
                            if (activities.activity3) completedActivities.push('letter recognition');
                            else incompleteActivities.push('letter recognition');
                            
                            if (activities.vocabulary) completedActivities.push('basic vocabulary');
                            else incompleteActivities.push('basic vocabulary');
                        }
                        
                        else if (subject.id === 'phonics') {
                            if (activities.activity1) completedActivities.push('letter A-E recognition');
                            else incompleteActivities.push('letter A-E recognition');
                            
                            if (activities.activity2) completedActivities.push('A/B/C revision');
                            else incompleteActivities.push('A/B/C revision');
                            
                            if (activities.vocabulary) completedActivities.push('phonics vocabulary');
                            else incompleteActivities.push('phonics vocabulary');
                        }
                        
                        else if (subject.id === 'mathematics') {
                            if (activities.activity1) completedActivities.push('counting 1-10');
                            else incompleteActivities.push('counting 1-10');
                            
                            if (activities.activity2) completedActivities.push('number tracing');
                            else incompleteActivities.push('number tracing');
                            
                            if (activities.activity3) completedActivities.push('quantity matching');
                            else incompleteActivities.push('quantity matching');
                            
                            if (activities.activity4) completedActivities.push('finger counting');
                            else incompleteActivities.push('finger counting');
                        }
                        
                        else if (subject.id === 'iq') {
                            if (activities.activity1) completedActivities.push('animal-food matching');
                            else incompleteActivities.push('animal-food matching');
                            
                            if (activities.activity2) completedActivities.push('shapes and colors');
                            else incompleteActivities.push('shapes and colors');
                            
                            if (activities.activity3) completedActivities.push('room objects identification');
                            else incompleteActivities.push('room objects identification');
                        }
                        
                        else if (subject.id === 'social-studies') {
                            if (activities.activity1) completedActivities.push('farm animal characteristics');
                            else incompleteActivities.push('farm animal characteristics');
                            
                            if (activities.activity2) completedActivities.push('animal sounds and offspring');
                            else incompleteActivities.push('animal sounds and offspring');
                            
                            if (activities.activity3) completedActivities.push('body parts identification');
                            else incompleteActivities.push('body parts identification');
                        }
                        
                        else if (subject.id === 'science') {
                            if (activities.activity1) completedActivities.push('floating/sinking experiments');
                            if (activities.activity2) completedActivities.push('dancing beans experiment');
                            if (activities.activity3) completedActivities.push('buoyancy exploration');
                            if (activities.activity4) completedActivities.push('balloon experiments');
                            if (activities.activity5) completedActivities.push('magnifying glass use');
                            if (activities.activity6) completedActivities.push('milk color experiment');
                        }
                        
                        else if (subject.id === 'conversation') {
                            if (activities.activity1) completedActivities.push('age questions');
                            if (activities.activity2 || activities.activity3 || activities.activity4 || activities.activity5 || activities.activity6) {
                                completedActivities.push('daily routine conversations');
                            }
                            if (activities.activity7 || activities.activity8 || activities.activity9) {
                                completedActivities.push('food conversations');
                            }
                        }
                        
                        else if (subject.id === 'arts') {
                            if (activities.activity1) completedActivities.push('paper crafts');
                            if (activities.activity2) completedActivities.push('origami skills');
                            if (activities.activity3) completedActivities.push('textile crafts');
                            if (activities.activity4) completedActivities.push('creative constructions');
                        }
                        
                        else if (subject.id === 'pe') {
                            if (activities.activity1 || activities.activity2 || activities.activity3) {
                                completedActivities.push('ball skills');
                            }
                            if (activities.activity4) completedActivities.push('racing activities');
                            if (activities.activity5) completedActivities.push('coordination games');
                            if (activities.activity6) completedActivities.push('football skills');
                        }
                        
                        else if (subject.id === 'puppet') {
                            if (activities.activity1 || activities.activity2 || activities.activity3 || activities.activity4 || activities.activity5) {
                                completedActivities.push('storytelling performances');
                            }
                        }
                        
                        // Generate activity-specific comments
                        if (completedActivities.length >= 2) {
                            comment += `In ${subject.name}, ${pronoun.subject} has shown excellent progress with ${completedActivities.slice(0, 2).join(' and ')}, demonstrating strong foundational skills. `;
                        } else if (completedActivities.length > 0) {
                            comment += `${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} is developing ${subject.name.toLowerCase()} skills and has made good progress with ${completedActivities[0]}. `;
                        }
                        
                        if (incompleteActivities.length > 0 && incompleteActivities.length <= 2) {
                            comment += `Continued practice with ${incompleteActivities.join(' and ')} will further strengthen ${pronoun.possessive} ${subject.name.toLowerCase()} foundation. `;
                        }
                    }
                });
            }
            
            // Incorporate specific strengths
            if (strengths.trim()) {
                const strengthsList = strengths.split(',').map(s => s.trim()).filter(s => s);
                if (strengthsList.length > 0) {
                    const randomStrength = strengthsList[Math.floor(Math.random() * strengthsList.length)];
                    comment += `${pronoun.possessive.charAt(0).toUpperCase() + pronoun.possessive.slice(1)} ${randomStrength.toLowerCase()} is particularly noteworthy and contributes to ${pronoun.possessive} overall success in the classroom. `;
                }
            }
            
            // Address growth areas constructively
            if (weaknesses.trim()) {
                comment += `Moving forward, we will continue to support ${studentName} in developing ${weaknesses.toLowerCase()}. `;
                comment += `With ${pronoun.possessive} positive attitude and willingness to learn, I am confident ${pronoun.subject} will make continued progress in these areas. `;
            }
            
            // Personalized future-focused closing
            const futureClosings = [
                `${studentName} has shown wonderful growth this term, and I am excited to see ${pronoun.possessive} continued development. ${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} is well-prepared for future learning challenges.`,
                `I am proud of ${studentName}'s achievements and the progress ${pronoun.subject} has made. ${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} approaches learning with curiosity and determination.`,

                `${studentName} is a valued member of our classroom community. ${pronoun.subject.charAt(0).toUpperCase() + pronoun.subject.slice(1)} has established a strong foundation for continued academic and social success.`,
                `Working with ${studentName} has been rewarding, and ${pronoun.subject} consistently demonstrates the qualities that will serve ${pronoun.object} well in future educational endeavors.`
            ];
              comment += futureClosings[Math.floor(Math.random() * futureClosings.length)];
            
            return comment;
        }
        
        // Test function to diagnose iframe issues
        function testFrames() {
            console.log('=== FRAME DIAGNOSTIC TEST ===');
            
            // Test student info frame
            console.log('Student info frame:', studentInfoFrame);
            if (studentInfoFrame) {
                console.log('Student frame has getStudentData:', typeof studentInfoFrame.getStudentData);
                if (studentInfoFrame.getStudentData) {
                    try {
                        const studentData = studentInfoFrame.getStudentData();
                        console.log('Student data retrieved:', studentData);
                    } catch (e) {
                        console.error('Error getting student data:', e);
                    }
                }
            }
            
            // Test subjects frame
            console.log('Subjects frame:', subjectsFrame);
            if (subjectsFrame) {
                console.log('Subjects frame has getSubjectData:', typeof subjectsFrame.getSubjectData);
                if (subjectsFrame.getSubjectData) {
                    try {
                        const subjectData = subjectsFrame.getSubjectData();
                        console.log('Subject data retrieved:', subjectData);
                    } catch (e) {
                        console.error('Error getting subject data:', e);
                    }
                }
            }
            
            // Test comment elements
            const comment1Element = document.getElementById('comment1');
            const comment2Element = document.getElementById('comment2');
            console.log('Comment 1 element found:', !!comment1Element);
            console.log('Comment 2 element found:', !!comment2Element);
            
            // Try to generate a test comment
            try {
                const testComment = "This is a test comment to verify the system is working.";
                if (comment1Element) {
                    comment1Element.innerHTML = testComment + '<div class="word-count">12 words</div>';
                    console.log('Test comment set successfully');
                }
            } catch (e) {
                console.error('Error setting test comment:', e);
            }
            
            showNotification('Frame diagnostic complete - check console for details');
        }
    </script>
</body>
</html>
